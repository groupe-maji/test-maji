<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>TEST PERSONNALITÉ MAJI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #timer { font-weight: bold; font-size: 1.2em; color: red; }
    #form-mail { display: none; }
    #result-message { font-size: 1.1em; color: green; margin-top: 20px; }
  </style>
</head>
<body>
  <div id="intro">
    <h1>TEST PERSONNALITÉ MAJI</h1>
    <p>Vous avez 20 secondes par question. Entrez votre nom, puis cliquez sur "Démarrer" pour commencer.</p>
    <input type="text" id="user-name" placeholder="Nom et prénom" style="margin-bottom:10px; width: 300px;"><br>
    <button id="start-button">Démarrer</button>
    <p id="name-error" style="color:red;"></p>
  </div>

  <div id="question-block" style="display:none">
    <h2 id="question"></h2>
    <div id="choices"></div>
    <button id="validate-button">Valider</button>
    <p id="feedback"></p>
    <p id="timer"></p>
  </div>

  <div id="result-message"></div>

  <script type="module">
    import emailjs from 'https://cdn.emailjs.com/dist/email.min.mjs';
    window.emailjs = emailjs;

    const startButton = document.getElementById("start-button");
    const validateButton = document.getElementById("validate-button");

    const questions = [
      { question: "Quel est le nombre suivant dans la série : 2, 4, 8, 16, ?", choices: ["18", "24", "32", "20", "30"], answer: "32" },
      { question: "Quel est l'intrus : cercle, carré, triangle, rectangle, cube ?", choices: ["cercle", "carré", "triangle", "rectangle", "cube"], answer: "cube" },
      { question: "Combien de côtés a un hexagone ?", choices: ["4", "5", "6", "7", "8"], answer: "6" },
      { question: "Quel est l’anagramme correcte de ‘chien’ ?", choices: ["niche", "chine", "hienc", "ceinh", "chin"], answer: "niche" },
      { question: "Si tous les chats sont des mammifères, et que certains mammifères sont gris, peut-on conclure que certains chats sont gris ?", choices: ["Oui", "Non", "Parfois", "Toujours", "Impossible à dire"], answer: "Impossible à dire" },
      { question: "Quelle est la moyenne de ces nombres : 10, 20, 30, 40, 50 ?", choices: ["25", "30", "35", "40", "45"], answer: "30" },
      { question: "Quel est le mot le plus différent : couteau, fourchette, cuillère, assiette, verre ?", choices: ["couteau", "fourchette", "cuillère", "assiette", "verre"], answer: "assiette" }
    ];

    let index = 0;
    let score = 0;
    let timer;
    let countdown;
    const maxTime = 20;

    startButton.addEventListener("click", startTest);
    validateButton.addEventListener("click", submitAnswer);

    function startTest() {
      const name = document.getElementById("user-name").value.trim();
      if (!name) {
        document.getElementById("name-error").innerText = "Veuillez entrer votre nom.";
        return;
      }
      document.getElementById("name-error").innerText = "";
      document.getElementById("intro").style.display = "none";
      showQuestion();
    }

    function showQuestion() {
      if (index >= questions.length) {
        finishTest();
        return;
      }
      const current = questions[index];
      document.getElementById("question").innerText = current.question;
      document.getElementById("feedback").innerText = "";
      const choicesDiv = document.getElementById("choices");
      choicesDiv.innerHTML = "";

      current.choices.forEach((choice, i) => {
        const label = String.fromCharCode(65 + i);
        const radio = `<label><input type='radio' name='answer' value='${choice}'> (${label}) ${choice}</label><br>`;
        choicesDiv.innerHTML += radio;
      });

      document.getElementById("question-block").style.display = "block";
      startTimer();
    }

    function submitAnswer() {
      clearTimeout(timer);
      clearInterval(countdown);
      const current = questions[index];
      let userAnswer = document.querySelector('input[name="answer"]:checked')?.value || "";
      if (userAnswer.toLowerCase() === current.answer.toLowerCase()) {
        score++;
        document.getElementById("feedback").innerText = "Correct !";
      } else {
        document.getElementById("feedback").innerText = "Faux. Réponse attendue : " + current.answer;
      }
      index++;
      setTimeout(showQuestion, 1000);
    }

    function startTimer() {
      let timeLeft = maxTime;
      document.getElementById("timer").innerText = `Temps restant : ${timeLeft}s`;
      countdown = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerText = `Temps restant : ${timeLeft}s`;
        if (timeLeft <= 0) clearInterval(countdown);
      }, 1000);
      timer = setTimeout(() => {
        document.getElementById("feedback").innerText = "Temps écoulé ! Réponse attendue : " + questions[index].answer;
        index++;
        setTimeout(showQuestion, 1000);
      }, maxTime * 1000);
    }

    function finishTest() {
      document.getElementById("question-block").style.display = "none";

      const name = document.getElementById("user-name").value.trim();
      const profil = score <= 5 ? "Profil logique faible" : score <= 6 ? "Profil moyen" : "Profil logique fort";
      const qi = score <= 5 ? 80 : score <= 6 ? 100 : 120;

      const message = {
        nom: name,
        score: score,
        profil: profil,
        qi: qi
      };

      emailjs.init("lvSCbMjI4S98izJHf");
      emailjs.send("service_37qqsvm", "template_y022b36", message)
        .then((res) => {
          console.log("Email envoyé !", res.status);
        })
        .catch((err) => {
          console.error("Erreur EmailJS", err);
        });

      document.getElementById("result-message").innerText = `Merci ${name}, votre test est terminé. Score : ${score}/${questions.length}. Vos résultats ont été transmis.`;
    }
  </script>
</body>
</html>
